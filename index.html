<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Spellfall</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg"/>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet"/>
</head>
<body>
  <div id="app" class="app">
    <canvas id="game" width="800" height="600"></canvas>
    <div id="flash" class="flash"></div>
    <div id="startScreen" class="overlay visible">
      <h1 class="title">Spellfall</h1>
      <p class="subtitle">Make words using falling consonants. Vowels are free. Press Enter to submit.</p>
      <button id="startBtn" class="btn">Start</button>
      <p class="hint">Tip: use Backspace to edit. Words must be 3+ letters. Vowels are free!</p>
    </div>
    <div id="gameOverScreen" class="overlay hidden">
      <h2 class="title">Game Over</h2>
      <p class="subtitle">Nice run. Want to go again?</p>
      <button id="restartBtn" class="btn">Start Game</button>
      <p class="final-score">Final Score: <span id="finalScore">0</span></p>
    </div>
  </div>
  <div id="hud" class="hud">
    <div id="timer" class="hud-left">Time: <span id="timeValue">--</span></div>
    <div id="assemblyBar" class="assembly"></div>
    <div id="score" class="hud-right">Score: <span id="scoreValue">0</span></div>
  </div>
  <script type="module">
    import { Game } from './src/game.js';
    import { Config } from './src/config.js';
    import { initInput } from './src/input.js';
    import { Dictionary } from './src/dictionary.js';
    const canvas = document.getElementById('game');
    const game = new Game(canvas);
    const startScreen = document.getElementById('startScreen');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const startBtn = document.getElementById('startBtn');
    const restartBtn = document.getElementById('restartBtn');
    const assemblyBar = document.getElementById('assemblyBar');
    const scoreValue = document.getElementById('scoreValue');
    const timeValue = document.getElementById('timeValue');
    const finalScore = document.getElementById('finalScore');
    const flash = document.getElementById('flash');
    const scoreEl = document.getElementById('score');
    scoreEl.style.color = Config.SCORE_COLOR;
    initInput({
      onLetter: (ch) => game.onLetter(ch),
      onBackspace: () => game.onBackspace(),
      onSubmit: () => game.onSubmit()
    });
    const dict = new Dictionary();
    let dictReady = false;
    dict.load('./assets/wordlist.txt').then(() => { dictReady = true; }).catch(() => { dictReady = true; });
    function show(el){ el.classList.remove('hidden'); el.classList.add('visible'); }
    function hide(el){ el.classList.remove('visible'); el.classList.add('hidden'); }
    function flashScreen(){
      flash.style.transition='none';
      flash.style.opacity='1';
      requestAnimationFrame(()=>{flash.style.transition=`opacity ${Config.FLASH_FADE_MS}ms ease-out`;flash.style.opacity='0';});
    }
    game.onRenderHUD = (hud) => {
      scoreValue.textContent = hud.score.toString();
      timeValue.textContent = hud.timeLeft.toFixed(1);
      const timerEl = document.getElementById('timer');
      if (hud.timeLeft <= Config.LOW_TIME_THRESHOLD_SEC) {
        timerEl.classList.add('low');
      } else {
        timerEl.classList.remove('low');
      }
      assemblyBar.textContent = hud.assemblyText;
      assemblyBar.classList.toggle('ok', hud.assemblyFlash === 'ok');
      assemblyBar.classList.toggle('bad', hud.assemblyFlash === 'bad');
    };
    game.onWordAccepted = flashScreen;
    game.onStateChange = (state) => {
      if (state === 'Start') { show(startScreen); hide(gameOverScreen); }
      else if (state === 'Playing') { hide(startScreen); hide(gameOverScreen); }
      else if (state === 'GameOver') { hide(startScreen); show(gameOverScreen); finalScore.textContent = game.score.toString(); }
    };
    startBtn.addEventListener('click', async () => {
      if (!dictReady) await new Promise(r => setTimeout(r, 200));
      game.start(dict);
    });
    restartBtn.addEventListener('click', () => { game.reset(); game.start(dict); });
  </script>
</body>
</html>
